---
- name: Ensure system is unregisterd with RHC
  ansible.builtin.import_playbook: rhsm.yml
  vars:
    target: sat_systems
    rhc_state: absent 

- name: Shutdown and remove existing virtual machines 
  hosts: kvm_host
  gather_facts: False
  become: True 

  tasks: 
    - name: Stop all node VMs
      community.libvirt.virt:
        name: "{{ item.key }}"
        state: shutdown
      loop: "{{ satellite_systems | dict2items }}"
      loop_control:
          label: "{{ item.key }}"
      ignore_errors: true

    - name: Pause for vms to shutdown 
      ansible.builtin.pause:
        seconds: 10 

    - name: Undefine node VMs
      community.libvirt.virt:
        command: undefine
        name: "{{ item.key }}"
        #force: true
      loop: "{{ satellite_systems | dict2items }}"
      loop_control:
          label: "{{ item.key }}"
      ignore_errors: true 

    - name: Pause for vms to undefine 
      ansible.builtin.pause:
        seconds: 15 